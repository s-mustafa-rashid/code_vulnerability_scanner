import os
from flask import Blueprint, render_template, request, jsonify
from werkzeug.utils import secure_filename
from .analyzers.js_analyzer import JavaScriptAnalyzer
from .analyzers.python_analyzer import PythonAnalyzer
from .analyzers.terraform_analyzer import TerraformAnalyzer

bp = Blueprint('main', __name__)

@bp.route('/')
def index():
    return render_template('index.html')

@bp.route('/analyze', methods=['POST'])
def analyze_code():
    if 'file' not in request.files:
        return jsonify({'error': 'No file part'})

    file = request.files['file']
    if file.filename == '':
        return jsonify({'error': 'No selected file'})

    # Get file extension
    _, file_extension = os.path.splitext(file.filename)
    file_extension = file_extension.lstrip('.')  # Remove leading dot

    if file_extension == 'py':
        language = 'python'
    elif file_extension in ['js', 'jsx']:
        language = 'javascript'
    elif file_extension == 'tf':
        language = 'terraform'
    else:
        return jsonify({'error': 'Unsupported file type'})

    if language == 'python':
        analyzer = PythonAnalyzer(file.read().decode('utf-8'))
    elif language == 'javascript':
        analyzer = JavaScriptAnalyzer(file.read().decode('utf-8'))
    elif language == 'terraform':
        analyzer = TerraformAnalyzer(file.read().decode('utf-8'))
    else:
        return jsonify({'error': 'Invalid language'})

    analysis_result = analyzer.analyze()
    return jsonify(analysis_result)
